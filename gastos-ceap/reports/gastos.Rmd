---
title: "Análise dos Gastos de Deputados"
author: "Valter Lucena"
date: "27 de agosto de 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(tidyverse)
library(here)
```

# Dados

```{r}
gastos <- read_csv(here("data/dadosCEAP.csv"),
                   progress = FALSE)

gastos <- gastos %>% 
  mutate(regiao = case_when(
    sgUF %in% c("AC", "AP", "AM", "PA", "RO", "RR", "TO") ~ "Norte",
    sgUF %in% c("AL", "BA", "CE", "MA", "PB", "PE", "PI", "RN", "SE") ~ "Nordeste",
    sgUF %in% c("DF", "GO", "MT", "MS") ~ "Centro-Oeste",
    sgUF %in% c("ES", "MG", "RJ", "SP") ~ "Sudeste",
    sgUF %in% c("PR", "RN", "SC") ~ "Sul"
  ))

```


# Perguntas

1. Quais são os deputados que gastaram mais dinheiro da CEAP? Quais são os mais econômicos? (7,5 pts)
2. Quais os estados cujos deputados gastam mais no exterior? Quais os estados cujos deputados gastam menos no exterior? (7,5 pts)
3. Quais os partidos cujos parlamentares mais usam CEAP no estado da Paraíba? Quais são os que menos usam? Mesmas perguntas considerando valores em R$. (7,5 pts)
4. Quais os deputados que mais ultrapassam o limite de CEAP do seu estado? (7,5 pts)
5. Quais estados cujos parlamentares gastam mais com passagens aéreas? (7,5 pts)
6. Escolha três partidos e responda: Quais são os tipos de despesa mais utilizados no uso da CEAP pelos deputados desses partidos? Mesma pergunta considerando valores em R$. (7,5 pts)

## Quais são os deputados que gastaram mais dinheiro da CEAP? Quais são os mais econômicos? (7,5 pts)


```{r}

# mais gastam

gastos %>% 
  group_by(nomeParlamentar) %>% 
  summarise(total = sum(valorLíquido)) %>% 
  filter(total >= 0) %>% 
  arrange(-total) %>% 
  slice(1:10) %>%
  na.omit() %>% 
  ggplot(aes(x = reorder(nomeParlamentar, total),
             y = total,
             colour = total)) +
  geom_point(size = 2) +
  geom_segment(aes(x = reorder(nomeParlamentar, total),
                   xend = reorder(nomeParlamentar, total),
                   y = 0,
                   yend = total)) +
  coord_flip()
```

 
```{r}
# menos gastam
gastos %>% 
  group_by(nomeParlamentar) %>% 
  summarise(total = sum(valorLíquido)) %>% 
  filter(total >= 0) %>% 
  arrange(total) %>% 
  slice(1:10) %>%
  na.omit() %>% 
  ggplot(aes(x = reorder(nomeParlamentar, -total),
             y = total,
             colour = total)) +
  geom_point(size = 2) +
  geom_segment(aes(x = reorder(nomeParlamentar, -total),
                   xend = reorder(nomeParlamentar, -total),
                   y = 0,
                   yend = total)) +
  coord_flip()
```

## Quais os estados cujos deputados gastam mais no exterior? Quais os estados cujos deputados gastam menos no exterior?

```{r}
gastos %>%
  filter(tipoDocumento == 2) %>% 
  group_by(sgUF) %>%
  summarise(total = sum(valorLíquido)) %>% 
  ggplot(aes(x = reorder(sgUF, total),
             y = total,
             fill = total)) +
  geom_col(position = position_identity())
```

## Quais os partidos cujos parlamentares mais usam CEAP no estado da Paraíba? Quais são os que menos usam? Mesmas perguntas considerando valores em R$.

```{r}
partidos <- gastos %>% 
  filter(sgUF %in% c("PB")) %>% 
  group_by(sgPartido) %>%
  summarise(total = sum(valorLíquido), 
            quantidade = n())

partidos %>% 
  ggplot(aes(x = reorder(sgPartido, quantidade),
             y = quantidade,
             fill = quantidade)) +
  geom_col()

```

## Quais os deputados que mais ultrapassam o limite de CEAP do seu estado? 

```{r message = FALSE}
limiteMensal <- read_csv(here("data/limiteMensalCEAP.csv")) %>% 
  select(sgUF = UF,
         limite_mensal = limite_mensal)

gastos_totais <- gastos %>% 
  group_by(idCadastro, nomeParlamentar, sgUF, regiao) %>% 
  summarise(total_gasto = sum(valorLíquido))

gastos_totais <- left_join(gastos_totais, limiteMensal) %>% 
  mutate(diferenca = limite_mensal - total_gasto)

gastos_totais %>% 
  group_by(sgUF) %>% 
  filter(diferenca == min(diferenca)) %>% 
  arrange(diferenca) %>% 
  mutate(valor_ultrapassado = abs(diferenca)) %>% 
  ggplot(aes(x = reorder(nomeParlamentar, valor_ultrapassado),
             y = valor_ultrapassado,
             fill = regiao,
             label = sgUF)) +
  geom_col(position = "identity") +
  geom_text(position = position_stack(vjust = 1.05),
            size = 2.5) +
  coord_flip()
```

